<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body onload="runApp()">
<button id="draw">Draw</button>
<table>
    <tr>
        <td>
            <label for="fontName">Font name</label>
        </td>
        <td>
            <input id="fontName" value="Georgia">
        </td>
    </tr>
    <tr>
        <td>
            <label for="fontSize">Font size</label>
        </td>
        <td>
            <input id="fontSize" value="20">
        </td>
    </tr>
    <tr>
        <td>
            <label for="fontColor">Font color</label>
        </td>
        <td>
            <input id="fontColor" type="color" value="#ffffff">
        </td>
    </tr>
    <tr>
        <td>
            <label for="fontImport">@import url(...)</label>
        </td>
        <td>
            <input id="fontImport" type="text" value="">
        </td>
    </tr>
</table>
<canvas id="cnv" style="border: 1px solid black; display: none;"></canvas>
<img id="resImg" style="background-color: gray;"/>
<pre><div id="console"></div></pre>
<script>
    var globalResult = null;
    var globalCnv = null;
    function runApp() {
        document.getElementById('draw').onclick = function () {
            var strImportfont = document.getElementById('fontImport').value;
            if (strImportfont) {
                var element = document.getElementById('importCss');
                if (element) element.parentNode.removeChild(element);
                var strFamily = strImportfont.split('family=')[1].split('&')[0].split(':')[0];
                strFamily = replaceAll(strFamily, '+', ' ');
                var fntNameImput = document.getElementById('fontName');
                fntNameImput.value = strFamily;
                var cssElement = document.createElement('style');
                cssElement.type = 'text/css';
                cssElement.id = 'importCss';
                strImportfont = '@import url(' + strImportfont + ')';
                cssElement.appendChild(document.createTextNode(strImportfont));
                document.getElementsByTagName('head')[0].appendChild(cssElement);
            }
            var strFont = document.getElementById('fontSize').value + 'px ' + document.getElementById('fontName').value;
            var symbolsContext = getSymbolsContext([{from: 32, to: 150}, {from: 1040, to: 1116}], strFont, 320);
            globalResult = symbolsContext;
            var cnv = document.getElementById('cnv');
            globalCnv = cnv;
            cnv.width = symbolsContext.width;
            cnv.height = symbolsContext.height;
            var ctx = cnv.getContext('2d');
            ctx.font = strFont;
            ctx.fillStyle = document.getElementById('fontColor').value;
            ctx.textBaseline = "top";
            var symbols = symbolsContext.symbols;
            var res = '(function(){\n\treturn {height: ' + symbols['1'].height + ',\n';
            for (var symbol in symbols) {
                if (!symbols.hasOwnProperty(symbol)) continue;
                var comma = ',';
                ctx.fillText(symbol, symbols[symbol].x, symbols[symbol].y);
                res += "\t\t'" + symbol + "': { x:" + symbols[symbol].x + ", y:" + symbols[symbol].y + ", width: " + symbols[symbol].width + "}" + comma + "\n"
            }
            res = res.slice(0, res.length - 2);
            res += '\n\t};';
            res += '\n})();';
            document.getElementById('console').innerHTML = res;
            document.getElementById('resImg').setAttribute('src', cnv.toDataURL("image/png"));
        };
    }

    function replaceAll(str, a, b) {
        if (!str) return '';
        return str.split(a).join(b);
    }

    function getFontHeight(strFont) {
        var parent = document.createElement("span");
        parent.appendChild(document.createTextNode("height!ДдЙЇ"));
        document.body.appendChild(parent);
        parent.style.cssText = "font: " + strFont + "; white-space: nowrap; display: inline;";
        var height = parent.offsetHeight;
        document.body.removeChild(parent);
        return height;
    }


    function getSymbolsContext(arrFromTo, strFont, w) {
        var cnv = document.createElement('canvas');
        var ctx = cnv.getContext('2d');
        ctx.font = strFont;
        var textHeight = getFontHeight(strFont);
        var symbols = {};
        var currX = 0, currY = 0, cnvWidth = w, cnvHeight = textHeight;
        for (var k = 0; k < arrFromTo.length; k++) {
            var arrFromToCurr = arrFromTo[k];
            for (var i = arrFromToCurr.from; i < arrFromToCurr.to; i++) {
                var currentChar = String.fromCharCode(i);
                if (currentChar == '\\' || currentChar == '\'') {
                    currentChar = '\\' + currentChar
                }
                ctx = cnv.getContext('2d');
                var textWidth = ctx.measureText(currentChar).width;
                if (textWidth == 0) continue;
                if (currX + textWidth > cnvWidth) {
                    currX = 0;
                    currY += textHeight;
                    cnvHeight = currY + textHeight;
                }
                var symbol = {};
                symbol.x = currX;
                symbol.y = currY;
                symbol.width = textWidth;
                symbol.height = textHeight;
                symbols[currentChar] = symbol;
                currX += textWidth;
            }
        }
        return {symbols: symbols, width: w, height: cnvHeight};
    }

</script>

</body>
</html>
   
